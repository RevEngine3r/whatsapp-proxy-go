name: Create Release

on:
  push:
    tags:
      - 'release'
      - 'release-*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Install PowerShell
        run: |
          sudo apt-get update
          sudo apt-get install -y powershell
          pwsh --version

      - name: Run build-release.ps1
        run: |
          pwsh -File ./build-release.ps1
        continue-on-error: false

      - name: Extract version from first binary
        id: version
        run: |
          # Get version from first binary filename
          FIRST_FILE=$(ls dist/*.tar.gz dist/*.zip 2>/dev/null | head -n 1 | xargs basename)
          VERSION=$(echo "$FIRST_FILE" | sed -E 's/whatsapp-proxy-([0-9.]+)-.*/\1/')
          
          if [ -z "$VERSION" ]; then
            echo "Error: Could not extract version!"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $VERSION"

      - name: Verify build artifacts
        id: verify
        run: |
          FILE_COUNT=$(ls dist/*.tar.gz dist/*.zip 2>/dev/null | wc -l)
          CHECKSUM_EXISTS=$(test -f dist/checksums.txt && echo "true" || echo "false")
          
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "checksum_exists=$CHECKSUM_EXISTS" >> $GITHUB_OUTPUT
          echo "Found $FILE_COUNT build artifacts"
          
          if [ "$CHECKSUM_EXISTS" = "true" ]; then
            echo "Checksums file found"
            cat dist/checksums.txt
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          COMMIT=$(git rev-parse --short HEAD)
          
          cat > release_notes.md << 'EOF'
          ## WhatsApp Proxy Go v$VERSION
          
          **Auto-generated release** from tag: `$TAG_NAME`
          
          ### ðŸ“¦ Installation
          
          Download the appropriate binary for your system below.
          
          #### Linux
          ```bash
          # Download (replace VERSION and ARCH as needed)
          wget https://github.com/RevEngine3r/whatsapp-proxy-go/releases/download/$TAG_NAME/whatsapp-proxy-$VERSION-linux-amd64.tar.gz
          
          # Extract
          tar -xzf whatsapp-proxy-$VERSION-linux-amd64.tar.gz
          
          # Run
          ./whatsapp-proxy-$VERSION-linux-amd64 --help
          ```
          
          #### macOS
          ```bash
          # Download (Intel)
          wget https://github.com/RevEngine3r/whatsapp-proxy-go/releases/download/$TAG_NAME/whatsapp-proxy-$VERSION-darwin-amd64.tar.gz
          
          # Or Apple Silicon
          wget https://github.com/RevEngine3r/whatsapp-proxy-go/releases/download/$TAG_NAME/whatsapp-proxy-$VERSION-darwin-arm64.tar.gz
          
          # Extract and run
          tar -xzf whatsapp-proxy-$VERSION-darwin-*.tar.gz
          ```
          
          #### Windows
          ```powershell
          # Download from releases page
          # Extract ZIP file
          # Run whatsapp-proxy.exe
          ```
          
          ### ðŸš€ Supported Platforms
          
          - **Linux**: amd64, arm64, 386, armv7
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Windows**: amd64, 386, arm64
          
          ### ðŸ“‹ Build Information
          
          - **Version**: $VERSION (datetime-based)
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **Commit**: $COMMIT
          - **Trigger Tag**: `$TAG_NAME`
          - **Build Artifacts**: ${{ steps.verify.outputs.file_count }} files
          
          ### ðŸ” Verification
          
          All binaries include SHA256 checksums. Verify your download:
          
          ```bash
          # Download checksums file
          wget https://github.com/RevEngine3r/whatsapp-proxy-go/releases/download/$TAG_NAME/checksums.txt
          
          # Verify (Linux/macOS)
          sha256sum -c checksums.txt --ignore-missing
          
          # Verify (Windows PowerShell)
          Get-FileHash whatsapp-proxy-*.zip -Algorithm SHA256
          ```
          
          ### ðŸ“– Documentation
          
          - [Installation Guide](https://github.com/RevEngine3r/whatsapp-proxy-go/blob/main/INSTALL.md)
          - [Configuration](https://github.com/RevEngine3r/whatsapp-proxy-go/blob/main/CONFIGURATION.md)
          - [README](https://github.com/RevEngine3r/whatsapp-proxy-go/blob/main/README.md)
          EOF
          
          # Substitute variables
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          sed -i "s/\$TAG_NAME/$TAG_NAME/g" release_notes.md
          sed -i "s/\$COMMIT/$COMMIT/g" release_notes.md
          
          echo "Release notes generated"

      - name: Delete existing tag/release (if exists)
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          gh release delete "$TAG_NAME" -y 2>/dev/null || true
          echo "Cleaned up any existing release for $TAG_NAME"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          
          gh release create "$TAG_NAME" \
            --title "WhatsApp Proxy Go v$VERSION" \
            --notes-file release_notes.md \
            dist/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: whatsapp-proxy-${{ steps.version.outputs.version }}
          path: dist/
          retention-days: 90

      - name: Upload coverage (optional)
        if: hashFiles('coverage.txt') != ''
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.txt
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
